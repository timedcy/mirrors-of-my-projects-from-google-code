require 'rubygems'
require "tmail"
require "yaml"

email_str = "Received: from [10.209.4.65] by staff-jes1.sina.com.cn\n (Sun Java System Messaging Server 6.2-3.04 (built Jul 15 2005))\n with ESMTPA id <0LCD00H8NT717B00@staff-jes1.sina.com.cn> for t@session.im;\n Wed, 24 Nov 2010 17:04:13 +0800 (CST)\nDate: Wed, 24 Nov 2010 17:04:17 +0800\nFrom: =?UTF-8?B?6JGj546J5Lyf?= <yuwei@staff.sina.com.cn>\nSubject: fg\nTo: t@session.im\nMessage-id: <4CECD511.9000301@staff.sina.com.cn>\nMIME-version: 1.0\nContent-type: multipart/mixed; boundary=\"Boundary_(ID_5V5ayhEDLdp+L67tTAvR0g)\"\nUser-Agent: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.1.9) Gecko/20100423\n Thunderbird/3.0.4\n\nThis is a multi-part message in MIME format.\n\n--Boundary_(ID_5V5ayhEDLdp+L67tTAvR0g)\nContent-type: text/plain; charset=UTF-8; format=flowed\nContent-transfer-encoding: 7BIT\n\nds\n\n--Boundary_(ID_5V5ayhEDLdp+L67tTAvR0g)\nContent-type: image/jpeg; name=face.jpeg\nContent-transfer-encoding: base64\nContent-disposition: attachment; filename=face.jpeg\n\n/9j/4AAQSkZJRgABAQEASABIAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRof\nHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwh\nMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAAR\nCAC0ALQDAREAAhEBAxEB/8QAHAABAAEFAQEAAAAAAAAAAAAAAAQBAgMFCAYH/8QAQxAAAQMC\nBAMEBQkFBwUAAAAAAQACAwQRBQYSIQcxURMiQWEycYGRsQgUFTdSc3WhwSM0NbPRJCUzYnJ0\nshdCkuHw/8QAGwEBAAIDAQEAAAAAAAAAAAAAAAEDAgUGBAf/xAAzEQACAgIBAwIDBgUFAQAA\nAAAAAQIDBBEFEiExEzIiQVEVNEJhcsEUcYGRoQYkM1Kx8P/aAAwDAQACEQMRAD8A5/QBAEAQ\nBAEAQBAEAQBAEAQBAEAQBAXMYXuA8PFXUUSumoxRDejYxs3DIIrn1XK6OnApqjuS2VdTb0jc\n4fliqrqpsc0kUJd4yOA8PNea7lMKr4dps2NXEZlketQejNieVX4ZU/N55GF4O4Nl4bOUw7Hq\nUS+PDXuPUmefxLDTRkObuHb2G4VNtEJx9WjvE8FtU6Z9Fi0zWrxmAQBAEAQBAEAQBAEAQBAE\nAQBAEAQFWt1PDepspS29A2cdMZJWwxM72w9ZXV41UMenb+m2U6c5aRv6WnbRx6GWLz6Tv0XJ\ncnyll83CHaKO14ria6oqya22bXC4pauujiZcu9In1b/otKo9TN9O5VQbfg2mZsehxhzWOgY2\nSAGNsjebgNhf3Kydjb8eDx0Yiri2n57ngMSc4VAv7F1v+n0pUyTOT56LjdHZrpqZ0kmtjTZ3\nTwVGXiOu1qPg08ZbRDXgMwgCAIAgCAICoBPIXQFzIZH30tJtzWShJ+ENlOzd0Wfo2fQjaLmw\nyPNmtuo9Gf0G0WFrhe4O3NYNNeSSigBAEAQGSBxbM0i3tXoxEndFMiXg9ZgWHSz0NVVxtu5m\n3LwIN1sOdyZV1qtfM2fC48bLet/Ik0lNPVyiGKMufe3qXIdLfg7L1YxXxHtMIqqLLlHPEGia\nrmbZ0h5N8h/94rJTjDsii3HsyWpN6SPBzuAkcB1KxSLpy12NdiYAbD9og3XW/wCnt+lJ/mcl\nz/8Ayx/kQ43RBv7QOJvtYreWUqb2zQpmrXGnoCAIAgCAzspZXs1kaW9XbXXopxbbvaiHJIzN\nghZYm7zttyC2tXELzYyt2fQvaQwgsa0WNxtuthDBoh4iYuTKtke2+l7m352Nl6FXBeERstus\n9EFzXuabtcWnyNk0gU1Gzgdw7n5qqVFUvMV/YnbLSyNwN2C58RtZeS3jaZ+FoyU2WOpWuI7J\n+58HbLW3cVZHvB7M1NGCWCSE2e0i/I9VrJwlB6ktGe9mNYAyQae2brdpHWyvxpKNsWyJeD6d\nw7x+lw0TUldC2WklNje3Pe3xWfOWL1478aN7xOPKdDlW9S2bnMOYaGCkNNgtFHRukdd8sdtR\nFuVwAei0MrU1qKN9ThTUuu6W2eIfUvGxJPtVShs90rnExadTi8g79Vl47HnktvqNdijS2oAN\n7aRb3LtOBX+1/wDvqchzr3k/0/ZERkscbbSRhxO4N7L335Sql0mnUdmsXJl4QBAXMYZHhreZ\nWUISm+mPkEuOFkbQXC8gPsW8xOLSSlb/AGKpT+hkc9z+Z26LcRhGHaK0VlqzAQBAFACAKQEA\nUAuc4uZof3m9D/Vee/FruWpIlNojTU41Ew3LehXP5XHzp+Jd0WxmmYN2u8wtf4Mzd0GIsjiA\n3D77r1XY7z4pxfxJePqbPjuQWKnCXhmwdiMUti+TfzXh+xctfhOgfOYrXdlrainc67pmD1qf\nsbL/AOpS+Zxd7bNhT1OHFpbNVRAEeBKj7Fy/+pZ9t4jWmzU4waeatAppg+JrR3/AbBdLx0JY\neLq7to5fk74ZGQ51+DRTT65LtaA0CwC0+RkyusczypaRgXmJCAuawvNgFZVVK2XTFEN6JrAG\nRhgHrK6fDwo0R38ymUthe4xCAIAoAUgIAgCAzU1JUVcgjp4XyvPJrBcrGUlFbYPR0nDnNtdE\nJIMFmc08rvY34kLzyzaI+ZGXSzDX5CzRhjC+qwedjRzILXfAlTDLpn4kR0s8+Wvhks5rmOHg\nRYq96aII9SztCZB6R5jqtFncdrdlf9i2M/kyOx5jeHDmDdaiE5Ql1LyWeSU2ojfcu7hW6o5Z\na1aip1/QvkMbH6RI13mF71yGO/xGPSwXwsJ1SX2B7qot5SqK+HuyVBkeapc9pjbtHe9lpcnL\nne+/gsjFIwLyGQQFzGOe4NaCT0CyjFyekCbpbG0NZ7T1XU4WIqId/JRKWwvcYhAEAQBAEAQB\nAegyllHEc34sKKhjdYAufLbZg8/eF58jIhRHqkSls6Zy5knAchYK6oMEc00Yu+okiaXXNhsb\nXXN3ZNuTPWyx6hHbMVfxENFod9GSCKQXjc4luoeWymOH1fM8sszp+Qw3iRQYhVtpaym7Fsm2\npxuPbsonhyitxZlXlxk9NELPfCfCsy0b6jD4o6OuaNTTFG1rX+RsB8VZi586nqXdHplFM5jx\nPDarCMQmoq2J0U8Ti1zXC3JdLCcbI7XhlXggTQBzdcYOoC7gtByOF0P1ILsWQlvsRFqCwIAg\nCAIAgJkMfZsDiO87cG/Jb7i8Xt6sv6FU5fIvW7KwgCgBSAgCAKAFICA6o4TYDTZXyJDX1QZH\nPUgySSHY21Gw38rLl+Qtd17ivkWpqMdsk4/nXB8RwupoWPma59gHhgI2IPXyUU4tkJKbPHdl\nVzi4o8FiNTDVU0bH4lLKIGaY2OhAt7b+QXsimnvXk8baa1vwaWnf/bIvHvBTN9iYLudEx4hB\npa03Gw5rkPtWh2dD8nQ/w89bPjXHnKkRoY8w00bQ9rg2YtB3BIAPvK6zich79NnlsXzPgQNv\nbsVvZxU4uMioi1EXZuBHou3C5HLodNjiXxe0YV5jIIAgCAviZ2klvDmVdRU7bFBEN6RMXYQi\noRUUedhZgIAoAUgIAgCAIDPRND6+na7cOlaD71jLtFg6pzU40/D7DmRbNc2Npt00krmMbvkN\nsrzXqo+YsikqJmxQtLnuNgAtjOaiup+DVwi29I3IyPjU0YeI4238HON/gtTPmcNPXWe+OBd9\nCRh2RcQjropKwxNhabu0uNz+S8eTz2LCtuEts9FPHWylprse/km3XzydjlPqZ00K9LRE4kxs\nqeGGICXwiY6566mr6Rw023XL8v2NJetSaOSF2h5SySMyNsN3eC1vJY/qV9S8ozg9MhrmS4IA\ngCAl0wLYid+95recTT5sZXY/kZFvSoIAgCAIAgCAIAgLo3mORr282kEexQ+6B1fhzW5z4YUD\noHB0vZiwB5OaS3xt0XLTfoZL2TbX6lekaDKWA4hRY8JKyjcyNjT3nEEA2K83N3J4U+l/T/1F\nOBTKNycke7fIBsOa+b929I6SMSNI2Y8mj/yCy/h7X4X+UWxcF8zHHQVk0zW9k4Anc3Ctq4/I\nnNJx7GcsiqMd7NBxqxaLCsgPoGvHa1BYxrb72Dmk/ldfSeHx9Til4ijQWy3t/U5eXVnnKtJa\n4Ecwoa2CHM3TKbXsdxdcdk1+na4noT2jGqCQgCAngWY1vQdLLrcGvooiiiT2wvYYhAFACkBA\nEAQBAEAQH1bhBxEblusOE4lIfo+a5Y5zwBG7n4+HP3rVcjh+quuHkzhLR0hI9lZQF9O9sjXt\nu1zTcH2hclnUysplWvJ6apJSTZ5qpE0btJjfceRXDWUW1vUov+xuq3CS2mX0sb6pjI2wyCXV\ncvN7AL3YtMroqCi+rfnuY2yVbbbWjf4pilJg2HSVlbMyKKNtyXOAv5brtq65TajE0jZyVxBz\npUZyx6WoJc2kYSIYy64AubH12XV4eKqIa+ZRKWzyK9hiEBhqhcMdbkLclznLV6sUvqW1vsRl\nqSwIAgNlKXGV2sWcDYgeC7WpagkedlisIKjcgID7vR8JMvT8OY8deJvnbsOFSe+62vsw7lfq\ntFLkLVkemvG9f5LOla2fDKhgiqZY28mvIHsK3cXtbZWYlkAgCAIAgCAckB7rKXFXMGVg2Bs5\nqaMH/ClANvUbX/NeHIwKru+tMyUmj6TSfKDwuSP+24ROJPHQ1pH5uWrnwrb7NMsVrRHxH5Qd\nM2JwwzCZBIeTpQAPycVlVwun3a/oQ7Wz5TmbPePZrk/vGscYgbiJgDWj3AXW3oxKqfaitybP\nNL0kBAEAmEjqNwDbsabk9L2C03Lx+BMsr8kBc+WhAEBs5zqqJT1eT+a7ePg8xjWQKt9IetQD\nrXDPqVh/Bm/yQuVs++P9X7l69pyhWfvs/wB474rqIe1FBgWYCAIAgCAIAgCAqASbAEnoFAMw\no6lwu2mmI6hhWPXH6gxPikj9ONzf9Qssk0wWqQFACkF5cRQVIB2Ibf3rV8r/AMBnDya1c0XB\nAEBs5i11RIWbtLiR6rrt4vcUzzGNZAq30h60B1rhf1LQ/gzf5IXKWffH+r9y9e05QrP36o+8\nd8V1EPaigwLIBSCXhkTJsUpY5BqY6VoI6i6rsbUW0DobP/D/ACzhXD+tr6PC4IqlkTXNkawA\ng7eS0GJl3TvUZS7FsorRzcujKiXhcTJ8XoopG6mPnY1w6guAKwseoNhH3ziHkPLmE8OJsQos\nMhiqmxsIkawAgm1/BaLDyrZ5CjJ9i2UVo+A4dQzYniMFFTtLpZnhjQBdb2c1CLkyo6My1wmy\n3ljBhiGY3RSztaHyOn0hjNuW/wDVc9fyF10+mrwXKCXklHOPC6kd2DWUJHIlsLSFj/D5ku/c\nbibCPLfD7O9I8UENBIbXJp9Gtvnteyrd2Vjv4t/1Gos5/wCIOSpcl48+lDnSUr+9FIRa4329\ny32HkrIhv5lclpnkF7DEIC5z420NQ1xs92nSOu61XLSSp0Zw8muXNlwQBAbF+nV3QQCAQCuz\nx5dVUX+R535LVcQVHpD1qAda4Z9SsP4M3+SFytn3x/q/cvXtOUKz99n+8d8V1EPaigwLMBAT\ncHH98Uf3zfiq7fYyUdVcUL/9LsQtz7Fv6Ll8H7yi6XtOSF1ZQTsE/juH/wC6i/5BYW+x/wAi\nUdOcVfqmn+6j+AXNYH3pFsvac35TxqLL2ZaPFZoDOynLjoBte7SP1XRZFTtrcE/JUnpntuIP\nFk5ywiOgp6R9KwOJedd9XL+i8WJx/oT6m9mUpbPl9rrZmB9a4D0+IDOEksbJBSdge0P/AG8w\ntVyrh6WvmZw8m7+UO0a8MdbfURf2Knh/xE2HwpbwrCgFlTpFOO6dRdsfBaTmJ9oxLKyGtEWh\nAEBPaXPgY8g8rXK6fjLOqlL6FM13C2RgVb6Q9aA61wz6lYfwZv8AJC5Sz74/1fuXr2nKFZ++\nz/eO+K6iHtRQYFmAgJuD/wAZo/vm/FV2+1ko6p4ofVdiH3Lf0XL4P3lF0vackrrCgnYL/HcP\n/wBzH/yCrt9j/kSjpzir9U0/3UfwC5rA+9Itl7TmbA8Fq8wYvBhtEzVPM6w6AWuT7gV0ltsa\noucvBUls+94FwawDAMPFZmOpZLIBqfq9BtumwK0VvJW2S6akWKCXkluzFwswLusbTvePsMcS\nsfRzbCdxRtcqcTMBzBj7cHwejljBYXF7mgDb2qnIwraodc2FJN6R4j5Q572GD/Ofgvdw/wCI\nxsPhS3hWEBhqy5rmxm9gL281y/J2dd+voXQXYjLXGYQBASqQ6tTLm9rgXWz4y7ot6fqYTXYy\nrpSkq30h61IOtcL+paH8Gb/JC5Sz74/1fuXr2nKNa13z2fun/Ed4eZXUQfwooMGl32T7llsD\nS77J9ybBMwjbGKS+37ZvxWFvsZKOr+ItLNW8NK+KnaXyGBpAb48ly2HJRyE2XS8HIZBHMWXW\nFB7DhvlmrzDmyj7GFzoKeVksr7bAB4/9ryZt8aqnvyzKK2zoDi+wRcMa5g5Na1oWh457yUWz\n8Hy/5P0EMmaKyZ4aZI4e5fnvcH8itny7arSRXDyTvlB11e3FKCkD5G0RiLrAnS5217/kq+Ij\nHpcvmTYfEVuys+ucCMEr5M2OxP5u9tJFCQZHCwJJGwWp5W2PpdG+5nBdzdfKH54Z/rPwVPD/\nAIibD4St4Vl0bC92wuBzVVtihByZKWzXucXOJK42cnKTbPQUWICAIC+OQxSNe3m03WUZOL2g\nTXODzraLNcuuxb1dWpI88lpgekF6SDqTKWespQZIwqgrsYoWvbRRRSxSTM56ACCCVy+Ri3u6\nUoxfkuUloyHGeFbnEl+AEnck9inp5v5/5G4lPpfhV9vAPdCnp5v5/wCRuI+l+FX2sA90Kenm\n/n/kbic7ZunojnCunwl0QpRKDCYbabWHK2y6DHjL0kp+Sp+ex0NkDiXgmP4FBR4nWU0Fa1pY\n+OeRrQ4C3W1+a5/LwrK5uUFtFsZJouruF+QqypdVuFPGCdRDJ9LfyNkhnZMVodMTV47nPKXD\nnB30WWxSSVjgW2hcHEEA2LiL+J8VbVjX5U+q3eg2o+DWZyz3hGOcJn07sVppMTlYC+FsrS6+\no7WvdWY2LZXlb6exDknE+T5BzXJlDNFPX3/YElszerSCP1utrl46vrcTCL0zpGapyXxFwqMV\nFRRVAtcNdK0SMJ9twudUcjFl2TRb2kaQ8NOHWEu+c1UtM1jd7S1QA/Nyu/jcufZf+EdMUQoe\nLOW8OzDR4Pg8dNDhpcWyztAa0bG3l08Vm+PtlW5z8kda3pHpc9YDlrNmBvnrauncYI3SRSMn\nHO23IrzYtt1M9RXkykk0cnVLGx1U0bDdjXloPkCuqi9rZQYZpuyhLGmznc/UtHyuT39KJbBf\nMgrSFgQBAEAQEmnn0tMb7lp5W8Cvfg5bonp+GYyjszuBa4gixC6lPa2UFEAQBAFICgFWPcw6\nmOLT1Bsmtgk/Sddp0/PJ7dO0Kx9OP0BGc9zzd7i49SbrJLQKIApBliqZ4DeGaSM/5XELFxT8\ngvlrquYWlqpnjo55KKEV4QI/Lcc1kCR9IVnZ9maufRa2ntDZYdEfOgYPRaZHgloO6oyshUVu\nXzMorbIUkhkkLnG5K5Oc3OTky9dixYAIAgCAIAgJlKXTu0Ei9trrdcdnOL9OfgrnH5oyEEEg\n8xst8u5UUUgIAgCAIAoAUgKAEAQBSAgLmML9RuAGi5JVN10aoOTJS2QpJXPNr7eC5TJyJXz6\npF6WjGvOSEAQBAEAQBAASDcGxQEqCZpDhK4g2uDzutvhci6/gs8Fcob7ozOaW2uOYuFv4TjN\ndUWVFFmAgCAIAgCAIAgCAIC4tDAHSHS0+Nl5cjLroW5PuZKLZCklLiQCQ0+C5nIyZ3y3LwXK\nOjGvMSEAQBAEAQBAEAQBAZo6hzD37vFrWJ5L14+ZbS+z7GLimZ2SNkPd2PQreY/JVW9pdmVu\nDRe5pabOFitimmYFFICAIAgCAICuk6dR2HVVWWwrW5vRKWzE6oYw7N1FafI5X8NSM1D6kd8j\n5PScSOi007JTe5PZYlosWBIQBAEAQBAEAQBAEAQBAEBIjqpbaS67bciF6acm2p/CyGkyVA0S\nxkuFiATst1jZlk+0iqUUgWARB1zclbOEmzAsWYCgGdkLXThhJta6pna4+CUiK+UxnugcuftW\nlyc+7uk9FkYojyyvlPfdfe61U7JTe5MsS0Y1gAgCAIAgCAIAgCA//9k=\n\n--Boundary_(ID_5V5ayhEDLdp+L67tTAvR0g)--"



def get_attachment(str)
    mail = TMail::Mail.parse(str)
    index = 0
    mail.parts.each do |m|
        puts m.transfer_encoding
        m.base64_decode
        File.open("/tmp/#{index}.#{ext(m)}", 'w') {|f|
             f.write m.body
        }
        index += 1
    end
end

def ext( mail )
    mapping  = {
      'image/jpeg' => 'jpeg',
      'image/gif'  => 'gif',
      'image/png'  => 'png',
      'image/tiff' => 'tiff'
    }
   return mapping[mail.content_type] || 'txt'
end

get_attachment(email_str)
